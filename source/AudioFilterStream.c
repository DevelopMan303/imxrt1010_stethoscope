/**
 * AudioFilterStream.c
 *
 *  Created on: 22.12.2019
 *      Author: cons
 * SPDX-License-Identifier: BSD-3-Clause
 *
 */

#include <math.h>

#include "AudioFilterStream.h"
#include "fsl_debug_console.h"

const int NUMBER_OF_MODES = 4;

/**
 * @brief convert values from audio stream to int16 (signed). 4 Values needed minimum!
 */
int16_t GetMonoValueFromStereoAudioStream(const uint8_t * data){
	int16_t value = (data[3]<<8) | data[2];

	return value;
}

bool Test_GetMonoValueFromStereoAudioStream(){
	uint8_t in[] =  {0x12,0x23,0x34, 0x56};
	int16_t out =    0x5634;
	return GetMonoValueFromStereoAudioStream(in) == out;
}

/**
 * @brief value is put to audio stream. L+R is identical.
 * size of data minimum 4!
 */
void PutMonoValue2StereoAudioStream(const int16_t value, uint8_t * data){
	data[1]=value>>8;
	data[0]=value;
	data[3]=value>>8;
	data[2]=value;
}

bool Test_PutMonoValue2StereoAudioStream(){
	const int16_t in = 0xF12A;
	const uint8_t out [] = { 0x2a, 0xf1, 0x2a, 0xf1};

	/* hack the const size limitiation */
	enum NBR_OF_VALUES {NBR_OF_VALUES = 4};
	uint8_t value[NBR_OF_VALUES] = {0};

	PutMonoValue2StereoAudioStream(in, value);

	for (int i = 0; i < NBR_OF_VALUES; ++i) {
		// PRINTF("%x %x;\n", out[i], value[i]);
		if (out[i]!=value[i]){
			return false;
		}
	}
	return true;
}

/**
 * @brief Move from double to the proper int16 value range. To remove clipping.
 * Amplificate non linear.
 *
 * @param 	d value to use;
 * @paran 	mode kind of amplification (0 to 3) 0 = none;
 *
 */
int16_t AudioFilterAmplificateLimitINT16(double d, const int mode){
	/* Octave:
	 * SLOPE = 0.00012207;MAX_VALUE = 32768-300;t=[-MAX_VALUE:100:MAX_VALUE];
	 * plot(t, tanh(t*SLOPE)*MAX_VALUE)
	 */

	// const double SLOPE_1 = 0.0000122;
	const double SLOPE_2 = 0.00012207;
	const double SLOPE_3 = 0.00112207;
	const int MAX_VALUE = 32768-300;

	if (mode == 0
		|| mode == 1
		|| mode > NUMBER_OF_MODES)
	{
		if (d>MAX_VALUE) return MAX_VALUE;

		if (d<(-1)*MAX_VALUE) return (-1)*MAX_VALUE;

		return d;
	}

	double slope = 1;

	if (mode == 2) slope = SLOPE_2;
	else if (mode == 3) slope = SLOPE_3;

	d = tanh( d * slope) * MAX_VALUE;

	return d;
}

bool TEST_AudioFilterConvertINT16(){
	const int MAX_VALUE =  32768;
	const int MIN_VALUE = -32768;

	int16_t testValue=0;
	/* for all modes */

	for (int mode = 0; mode < 5; ++mode) {


		/* 0=0 */
		if (AudioFilterAmplificateLimitINT16(0, mode) != 0)
			return false;

		if (mode == 1){
			/* min/max not working */
			continue;
		}

		/* max value */
		testValue = AudioFilterAmplificateLimitINT16(MAX_VALUE, mode);

		if (testValue > MAX_VALUE)
			return false;

		if (testValue < MAX_VALUE - 10000)
			return false;

		/* min value */
		testValue = AudioFilterAmplificateLimitINT16(MIN_VALUE, mode);

		if (testValue < MIN_VALUE)
			return false;

		if (testValue > MIN_VALUE + 10000)
			return false;
	}

	return true;
}

void SimpleTestSuit(){
	PRINTF("Test_GetMonoValueFromStereoAudioStream: %d;\r\n", Test_GetMonoValueFromStereoAudioStream());
	PRINTF("Test_PutMonoValue2StereoAudioStream: %d;\r\n", Test_PutMonoValue2StereoAudioStream());
	PRINTF("TEST_AudioFilterConvertINT16: %d;\r\n", TEST_AudioFilterConvertINT16());
}

double BandPass_100Hz_800Hz(double invar)
{
    double sumnum=0.0, newin=0.0; int i=0, j=0;
    static double states[51][2] = {
        {0.0,0.0},
        {0.0,0.0},
        {0.0,0.0},
        {0.0,0.0},
        {0.0,0.0},
        {0.0,0.0},
        {0.0,0.0},
        {0.0,0.0},
        {0.0,0.0},
        {0.0,0.0},
        {0.0,0.0},
        {0.0,0.0},
        {0.0,0.0},
        {0.0,0.0},
        {0.0,0.0},
        {0.0,0.0},
        {0.0,0.0},
        {0.0,0.0},
        {0.0,0.0},
        {0.0,0.0},
        {0.0,0.0},
        {0.0,0.0},
        {0.0,0.0},
        {0.0,0.0},
        {0.0,0.0},
        {0.0,0.0},
        {0.0,0.0},
        {0.0,0.0},
        {0.0,0.0},
        {0.0,0.0},
        {0.0,0.0},
        {0.0,0.0},
        {0.0,0.0},
        {0.0,0.0},
        {0.0,0.0},
        {0.0,0.0},
        {0.0,0.0},
        {0.0,0.0},
        {0.0,0.0},
        {0.0,0.0},
        {0.0,0.0},
        {0.0,0.0},
        {0.0,0.0},
        {0.0,0.0},
        {0.0,0.0},
        {0.0,0.0},
        {0.0,0.0},
        {0.0,0.0},
        {0.0,0.0},
        {0.0,0.0},
        {0.0,0.0}
    };
    static int znumor[51] = {2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,1,1,1};
    static double znum[51][2] = {
        {1.0,-6.126771079805637e-03},
        {1.0,-1.081430449284354},
        {1.0,1.616881566083109},
        {1.456369509656216,-2.322437076559622},
        {1.0,1.859129733882106},
        {1.0,-1.766516691901861},
        {1.0,.732412973748586},
        {1.0,-.505115915385391},
        {1.0,1.272655792240197},
        {1.142454583242218,-2.10761092577492},
        {1.0,-1.469483314562759},
        {1.0,1.93697703896817},
        {1.0,.9603670750631803},
        {1.0,-.2575945580791135},
        {1.0,1.996041571147596},
        {1.0,-.8605131719717726},
        {1.0,-1.873331954971058},
        {1.0,1.367188052668019},
        {1.0,.3698104757822614},
        {1.0,-1.285474703494571},
        {1.0,1.964467796786133},
        {1.0,.8480759884984587},
        {1.0,-1.824084577942559},
        {1.0,-.6261754227890032},
        {1.0,1.751867481433113},
        {1.0,.1198504478773786},
        {1.0,-1.701894254080302},
        {1.0,1.173076565977746},
        {1.0,-1.185766951942931},
        {1.0,1.8090803629771},
        {1.0,-.1321072745298624},
        {1.0,1.539641154428465},
        {.8753083183071134,-1.844809375085743},
        {1.0,-.3820942123583347},
        {1.0,-1.63064975738726},
        {1.0,1.068843251213683},
        {1.0,1.9841819042796},
        {1.0,.6138342915284475},
        {1.0,-1.380167947339777},
        {1.0,1.68771684095593},
        {1.0,-1.553081828442704},
        {1.0,.4928076747844472},
        {1.0,-.7447965536188885},
        {1.0,-.9728711682910971},
        {1.0,1.901818106861476},
        {1.0,1.45630037267879},
        {.6866389287675046,-1.594675706378834},
        {1.0,.2453277734460344},
        {-1.000000000000058,1.0},
        {-.9999999999999418,1.0},
        {1.0,1.0}
    };
    static int zdenor[51] = {2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,1,1,1};
    newin = invar*-4.532014245613964e-03;
    for (i=0;i<51;i++){
        sumnum = 0.0;
        for (j=0;j<zdenor[i];j++){
            sumnum += states[i][j]*znum[i][j];
            if (j<zdenor[i]-1) states[i][j] = states[i][j+1];
        }
        states[i][zdenor[i]-1] = newin;
        if (znumor[i]==zdenor[i]) sumnum += states[i][zdenor[i]-1];
        newin = sumnum;
    }
    return newin;
}

double BandPass_50Hz_300Hz(double invar)
{
    double sumnum=0.0, newin=0.0; int i=0, j=0;
    static double states[51][2] = {
        {0.0,0.0},
        {0.0,0.0},
        {0.0,0.0},
        {0.0,0.0},
        {0.0,0.0},
        {0.0,0.0},
        {0.0,0.0},
        {0.0,0.0},
        {0.0,0.0},
        {0.0,0.0},
        {0.0,0.0},
        {0.0,0.0},
        {0.0,0.0},
        {0.0,0.0},
        {0.0,0.0},
        {0.0,0.0},
        {0.0,0.0},
        {0.0,0.0},
        {0.0,0.0},
        {0.0,0.0},
        {0.0,0.0},
        {0.0,0.0},
        {0.0,0.0},
        {0.0,0.0},
        {0.0,0.0},
        {0.0,0.0},
        {0.0,0.0},
        {0.0,0.0},
        {0.0,0.0},
        {0.0,0.0},
        {0.0,0.0},
        {0.0,0.0},
        {0.0,0.0},
        {0.0,0.0},
        {0.0,0.0},
        {0.0,0.0},
        {0.0,0.0},
        {0.0,0.0},
        {0.0,0.0},
        {0.0,0.0},
        {0.0,0.0},
        {0.0,0.0},
        {0.0,0.0},
        {0.0,0.0},
        {0.0,0.0},
        {0.0,0.0},
        {0.0,0.0},
        {0.0,0.0},
        {0.0,0.0},
        {0.0,0.0},
        {0.0,0.0}
    };
    static int znumor[51] = {2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,1,1,1};
    static double znum[51][2] = {
        {1.0,-1.9790486908949555789},
        {1.0,1.1761940156624506192},
        {1.0,.1270006940393281708},
        {1.0,1.9842413227817976322},
        {1.0,-1.6857902141114406085},
        {1.0,-.37296160801907296975},
        {1.0,1.3695712822198180103},
        {1.0,-.9612525355119731851},
        {1.0,1.8596591361573226525},
        {1.0,-1.3665160298686022798},
        {1.0,.4985170970882561257},
        {1.0,1.6888912232481242607},
        {1.0,-1.9606967720890468931},
        {1.0,-1.4552847063478826255},
        {1.0,1.0723557620263479628},
        {1.0,-.49548487938422984032},
        {1.0,1.9372138161997911397},
        {1.0,.25199106368042582793},
        {1.0,-1.0693140584969635943},
        {1.0,-.61604647782160806246},
        {1.0,1.6183227643763048671},
        {1.0,-1.7496754797983350851},
        {1.0,-1.8988777687478554799},
        {1.0,1.2753963591488497274},
        {1.0,-1.6152386598987221952},
        {1.0,1.9646012780094317195},
        {1.0,.73720532007674204429},
        {1.0,-.12397021793649203812},
        {1.0,1.8097979925544895419},
        {1.0,-1.8564437317516839314},
        {1.0,.96429140492702567701},
        {1.0,-.84939083703549751266},
        {1.0,-1.1731487800230784179},
        {1.0,1.996056439817361453},
        {1.0,.61907981047500173372},
        {1.0,1.5413735000391834964},
        {1.0,-1.5383017761969313151},
        {1.0,1.5151824448497127059e-03},
        {1.0,-.2489602503680410517},
        {1.0,1.7528003732631853156},
        {1.0,-1.9337248734197882493},
        {1.0,.85242743025349349822},
        {1.0,-.73417054737605662686},
        {1.0,1.9021870237423448068},
        {1.0,-1.8066378279494414547},
        {1.0,1.4583471160592666763},
        {1.0,-1.2723466989021385664},
        {1.0,.37599299549429838077},
        {-.99999999988443020401,1.0},
        {-1.000000000115569776,1.0},
        {1.0,1.0}
    };
    static int zdenor[51] = {2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,1,1,1};
    newin = invar*-1.3431121371260321529e-02;
    for (i=0;i<51;i++){
        sumnum = 0.0;
        for (j=0;j<zdenor[i];j++){
            sumnum += states[i][j]*znum[i][j];
            if (j<zdenor[i]-1) states[i][j] = states[i][j+1];
        }
        states[i][zdenor[i]-1] = newin;
        if (znumor[i]==zdenor[i]) sumnum += states[i][zdenor[i]-1];
        newin = sumnum;
    }
    return newin;
}


double LowPass_5kHz(double invar)
{
    double sumnum=0.0, newin=0.0; int i=0, j=0;
    static double states[53][2] = {
        {0.0,0.0},
        {0.0,0.0},
        {0.0,0.0},
        {0.0,0.0},
        {0.0,0.0},
        {0.0,0.0},
        {0.0,0.0},
        {0.0,0.0},
        {0.0,0.0},
        {0.0,0.0},
        {0.0,0.0},
        {0.0,0.0},
        {0.0,0.0},
        {0.0,0.0},
        {0.0,0.0},
        {0.0,0.0},
        {0.0,0.0},
        {0.0,0.0},
        {0.0,0.0},
        {0.0,0.0},
        {0.0,0.0},
        {0.0,0.0},
        {0.0,0.0},
        {0.0,0.0},
        {0.0,0.0},
        {0.0,0.0},
        {0.0,0.0},
        {0.0,0.0},
        {0.0,0.0},
        {0.0,0.0},
        {0.0,0.0},
        {0.0,0.0},
        {0.0,0.0},
        {0.0,0.0},
        {0.0,0.0},
        {0.0,0.0},
        {0.0,0.0},
        {0.0,0.0},
        {0.0,0.0},
        {0.0,0.0},
        {0.0,0.0},
        {0.0,0.0},
        {0.0,0.0},
        {0.0,0.0},
        {0.0,0.0},
        {0.0,0.0},
        {0.0,0.0},
        {0.0,0.0},
        {0.0,0.0},
        {0.0,0.0},
        {0.0,0.0},
        {0.0,0.0},
        {0.0,0.0}
    };
    static int znumor[53] = {2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,1,1,1,1,1,1,1,0};
    static double znum[53][2] = {
        {1.4142713152910760332,.25007305673744920809},
        {1.6366276594961418182,-1.5967523682591482643},
        {1.000000000000000015,1.9837002810896369832},
        {1.3271000343184284973,.55817845754676670504},
        {1.6902820625355962942,-2.2661125919401412425},
        {1.7113890764918646778,-2.5309134696673068147},
        {1.0000000000000000117,.95695307807449750444},
        {.99999999999999979874,1.6086419204763053007},
        {1.585904039619282273,-1.0202086406956467459},
        {1.6751935488560934881,-2.0753791466383231703},
        {1.5177800531555407385,-.38882027802146741843},
        {1.612970377651301996,-1.3181494057127000945},
        {1.0000000000000005677,1.8991002541358696644},
        {1.7169059599824424274,-2.5991162542085457434},
        {.99999999999999987892,1.2614063469831738776},
        {1.4727795565708097056,-6.7258474299353031681e-02},
        {1.5546369692286279126,-.70848793120877354727},
        {1.7024267536110971291,-2.4190607512199323375},
        {1.0000000000000001017,1.7459028835975695479},
        {1.6573075133145848574,-1.8507826675877265575},
        {.99999999999999992646,1.1622092463360277413},
        {.61997418790550406265,-.81721860734485378716},
        {1.0000000000000001767,1.935163969524725484},
        {.65885699177621298554,-.25617695871881474742},
        {.99999999999999970778,1.4460749862976683937},
        {.5873967839608095558,-1.4209485054724083584},
        {.75352269922408645845,.4206001379793767288},
        {1.0000000000000006447,1.8042533194202673448},
        {.58432066310127196696,-1.4788650368479418322},
        {.70707790590675057936,.17682113328161558949},
        {.59694594734014501267,-1.2388891707799953984},
        {1.0000000000000001934,1.6806027765565023333},
        {.99999999999999996419,1.0597967860063056182},
        {.6789882406626962479,-4.5667713134174688295e-02},
        {1.000000000000000057,1.9959191821374514849},
        {.58244308267776438991,-1.5138372833391091609},
        {.99999999999999985062,1.3562579324848893786},
        {.63055517548215811645,-.64329783846225738255},
        {.61101252578602019973,-.97563569758483156761},
        {.999999999999999887,1.5303440100808565922},
        {1.000000000000000237,1.9634120953925363197},
        {.60338832230357678831,-1.1167406487442967365},
        {1.0000000000000002838,1.8553957880587391328},
        {.64323698702223392992,-.45572564221234720626},
        {.59161723487729486922,-1.3406712655642458527},
        {-1.3110190922504961266,1.0},
        {-3.5988015921206456707,1.0},
        {1.8125601208764404452,1.0},
        {-.76276539823947159275,1.0},
        {-.2778702783141583503,1.0},
        {.55170583777185977905,1.0},
        {.99999999999999997737,1.0},
        {1.0,0.0}
    };
    static int zdenor[53] = {2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,1,1,1,1,1,1,1,1};
    newin = invar*5.4933803131942909722e-06;
    for (i=0;i<53;i++){
        sumnum = 0.0;
        for (j=0;j<zdenor[i];j++){
            sumnum += states[i][j]*znum[i][j];
            if (j<zdenor[i]-1) states[i][j] = states[i][j+1];
        }
        states[i][zdenor[i]-1] = newin;
        if (znumor[i]==zdenor[i]) sumnum += states[i][zdenor[i]-1];
        newin = sumnum;
    }
    return newin;
}



